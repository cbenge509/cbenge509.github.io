---
import type {HTMLAttributes} from 'astro/types';
import {cardSurfaceContainerClasses} from '../utils/card-styles';
import {BADGE_BASE_CLASSES, PATENT_STATUS_COLORS} from '../utils/badge';
import {cn} from '../utils/cn';

/**
 * PatentCard displays a single patent with status badge and external link.
 * Follows the same styling patterns as PublicationCard for consistency.
 *
 * Uses utilities:
 * - cardSurfaceContainerClasses() for consistent surface-based card styling
 * - PATENT_STATUS_COLORS for status badge colors
 * - BADGE_BASE_CLASSES for badge styling
 *
 * @example
 * ```astro
 * <PatentCard
 *   title="Method for Distributed Data Processing"
 *   patentNumber="US 10,123,456"
 *   filingDate={new Date('2018-03-15')}
 *   grantDate={new Date('2020-06-20')}
 *   status="granted"
 *   url="https://patents.google.com/patent/US10123456"
 *   description="A method for efficiently processing..."
 * />
 * ```
 */
export interface Props extends HTMLAttributes<'article'> {
  /** Patent title */
  title: string;
  /** Patent number (e.g., "US 10,123,456") */
  patentNumber: string;
  /** Date the patent was filed */
  filingDate: Date;
  /** Date the patent was granted (optional) */
  grantDate?: Date;
  /** Patent status */
  status: 'filed' | 'pending' | 'granted';
  /** URL to official patent document (optional) */
  url?: string;
  /** Brief description/abstract (optional) */
  description?: string;
}

const {
  title,
  patentNumber,
  filingDate,
  grantDate,
  status,
  url,
  description,
  class: className,
  ...attrs
} = Astro.props;

// Format date for display
const displayDate = grantDate || filingDate;
const dateLabel = grantDate ? 'Granted' : 'Filed';
const formattedDate = displayDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'short',
  day: 'numeric',
});

// Capitalize first letter for display
const statusLabel = status.charAt(0).toUpperCase() + status.slice(1);
---

<article
  data-component="patent-card"
  class={cardSurfaceContainerClasses(cn('patent-card', className))}
  {...attrs}
>
  <!-- Header: Date and Status Badge -->
  <div class="flex items-center justify-between gap-2 mb-2">
    <span
      class="text-sm text-text-secondary dark:text-text-secondary-dark"
      data-testid="patent-date"
    >
      {dateLabel}: {formattedDate}
    </span>
    <span
      class={cn(BADGE_BASE_CLASSES, PATENT_STATUS_COLORS[status])}
      data-testid="patent-status"
    >
      {statusLabel}
    </span>
  </div>

  <!-- Title -->
  <h3
    class="font-display text-lg md:text-xl font-semibold text-text dark:text-text-dark"
    data-testid="patent-title"
  >
    {title}
  </h3>

  <!-- Patent Number -->
  <p
    class="mt-1 font-mono text-sm text-text-secondary dark:text-text-secondary-dark"
    data-testid="patent-number"
  >
    {patentNumber}
  </p>

  <!-- Description (if provided) -->
  {
    description && (
      <p
        class="mt-3 text-sm text-text-secondary dark:text-text-secondary-dark leading-relaxed"
        data-testid="patent-description"
      >
        {description}
      </p>
    )
  }

  <!-- External Link (if URL provided) -->
  {
    url && (
      <div class="mt-4">
        <a
          href={url}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-1.5 text-sm text-accent dark:text-accent-dark hover:underline focus-ring rounded px-1 -mx-1 min-h-11"
          aria-label={`View patent ${patentNumber} on USPTO/Google Patents (opens in new tab)`}
          data-testid="patent-link"
        >
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
            />
          </svg>
          View Patent
          <span aria-hidden="true" class="text-xs">â†—</span>
        </a>
      </div>
    )
  }
</article>
