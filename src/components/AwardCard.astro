---
import type {HTMLAttributes} from 'astro/types';
import type {ImageMetadata} from 'astro';
import {Image} from 'astro:assets';
import {cardContainerClasses, BULLET_SEPARATOR} from '../utils/card-styles';
import {BADGE_BASE_CLASSES, AWARD_CATEGORY_COLORS, getPlacementBadgeColor} from '../utils/badge';
import {cn} from '../utils/cn';

/**
 * AwardCard displays a single award or competition honor with visual distinction.
 * Competition honors have placement badges (gold/silver/bronze).
 * Professional awards have a distinct professional badge and optional organization logo.
 *
 * Uses utilities:
 * - cardContainerClasses() for consistent card styling
 * - AWARD_CATEGORY_COLORS for category badge colors
 * - getPlacementBadgeColor() for placement badge styling
 * - BADGE_BASE_CLASSES for badge styling
 * - BULLET_SEPARATOR for accessible metadata separator
 * - Global line-clamp-2 utility for description truncation
 *
 * @example
 * ```astro
 * <AwardCard
 *   title="DrivenData: World Bank Publication Topics"
 *   year={2019}
 *   category="competition"
 *   description="Machine learning competition"
 *   placement="1st Place"
 *   organization="DrivenData"
 * />
 * ```
 *
 * @example With logo (professional awards)
 * ```astro
 * <AwardCard
 *   title="Circle of Excellence"
 *   year={2020}
 *   category="professional"
 *   description="Exceptional performance award"
 *   organization="Microsoft"
 *   logoImage={microsoftLogo}
 * />
 * ```
 */
interface Props extends HTMLAttributes<'article'> {
  /** Award or competition title */
  title: string;
  /** Year received */
  year: number;
  /** Award category */
  category: 'competition' | 'professional';
  /** Description of the award */
  description: string;
  /** Placement/ranking for competitions (e.g., "1st Place", "Top 12%") */
  placement?: string;
  /** Awarding organization */
  organization?: string;
  /** Optional logo image for the awarding organization */
  logoImage?: ImageMetadata;
}

const {
  title,
  year,
  category,
  description,
  placement,
  organization,
  logoImage,
  class: className,
  ...attrs
} = Astro.props;

const isCompetition = category === 'competition';
---

<article
  class={cardContainerClasses(cn('award-card group', className))}
  data-testid="award-card"
  {...attrs}
>
  <div class:list={['flex', logoImage ? 'items-start gap-4' : 'flex-col gap-3']}>
    {/* Optional Organization Logo */}
    {
      logoImage && (
        <div class="flex-shrink-0">
          <Image
            src={logoImage}
            alt={`${organization || 'Organization'} logo`}
            width={64}
            height={64}
            class="rounded-lg"
          />
        </div>
      )
    }

    {/* Card Content */}
    <div class:list={[logoImage ? 'flex-1 min-w-0' : '', 'flex flex-col gap-3']}>
      <!-- Badge Row: Category + Placement -->
      <div class="flex flex-wrap items-center gap-2">
        {/* Category Badge */}
        <span
          class={cn(BADGE_BASE_CLASSES, AWARD_CATEGORY_COLORS[category])}
          data-testid="category-badge"
        >
          {isCompetition ? 'Competition' : 'Professional'}
        </span>

        {/* Placement Badge (competitions only) */}
        {
          placement && isCompetition && (
            <span
              class={cn(BADGE_BASE_CLASSES, getPlacementBadgeColor(placement))}
              data-testid="placement-badge"
            >
              {placement}
            </span>
          )
        }
      </div>

      <!-- Award Title -->
      <h3 class="text-lg font-semibold text-text dark:text-text-dark">
        {title}
      </h3>

      <!-- Organization and Year -->
      <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-sm text-text-secondary dark:text-text-secondary-dark">
        {
          organization && (
            <>
              <span class="font-medium">{organization}</span>
              <Fragment set:html={BULLET_SEPARATOR} />
            </>
          )
        }
        <span>{year}</span>
      </div>

      <!-- Description -->
      <p class="text-sm text-text-secondary dark:text-text-secondary-dark line-clamp-2">
        {description}
      </p>
    </div>
  </div>
</article>
