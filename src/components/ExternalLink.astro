---
import type {HTMLAttributes} from 'astro/types';
import {cn} from '../utils/cn';

/**
 * ExternalLink - Reusable external link component with consistent styling and accessibility.
 *
 * Features:
 * - Always opens in new tab with security attributes
 * - Automatic aria-label enhancement with "(opens in new tab)"
 * - Multiple visual variants and sizes
 * - Optional prefix icons (PDF, GitHub, external)
 * - Arrow suffix indicator
 * - Dark mode support
 * - Focus ring for keyboard navigation
 *
 * VARIANTS:
 * - `text`: Inline link within text, subtle hover. Use in paragraphs.
 * - `button`: Solid filled button. Use for primary CTAs (Hero, Contact).
 * - `button-outlined`: Border button. Use for secondary CTAs next to solid buttons.
 * - `card-action`: Small link in cards. Use for PDF/Code/DOI links in cards.
 * - `badge`: Pill-shaped with backdrop blur. Use for floating overlays on images.
 *
 * SIZES: xs | sm | base | lg
 * - Button variants: affect padding and min-height
 * - Text/card-action: affect gap and font-size only
 *
 * COLOR SCHEMES (button variant only):
 * - `accent`: Blue background, white text (primary CTA)
 * - `neutral`: Surface background, text color, accent hover
 *
 * @example
 * ```astro
 * <!-- Text link -->
 * <ExternalLink href="https://example.com" ariaLabel="Example site">
 *   Visit Example
 * </ExternalLink>
 *
 * <!-- Button with accent color -->
 * <ExternalLink
 *   href="https://linkedin.com/in/user"
 *   variant="button"
 *   colorScheme="accent"
 *   ariaLabel="Connect on LinkedIn"
 * >
 *   Connect on LinkedIn
 * </ExternalLink>
 *
 * <!-- Card action with icon -->
 * <ExternalLink
 *   href="https://arxiv.org/pdf/123"
 *   variant="card-action"
 *   size="sm"
 *   prefixIcon="pdf"
 *   ariaLabel="Download PDF"
 * >
 *   PDF
 * </ExternalLink>
 * ```
 */
export interface Props extends HTMLAttributes<'a'> {
  /** External URL (required) */
  href: string;

  /** Visual style variant */
  variant?: 'text' | 'button' | 'button-outlined' | 'card-action' | 'badge';

  /** Size variant */
  size?: 'xs' | 'sm' | 'base' | 'lg';

  /** Accessible label - automatically appends "(opens in new tab)" */
  ariaLabel: string;

  /** Optional icon prefix */
  prefixIcon?: 'pdf' | 'github' | 'external' | 'none';

  /** Show arrow suffix (default: true) */
  showArrow?: boolean;

  /** Button color scheme (only for variant='button') */
  colorScheme?: 'accent' | 'neutral';

  /** Additional classes via cn() utility */
  class?: string;

  /** data-testid for testing */
  'data-testid'?: string;
}

const {
  href,
  variant = 'text',
  size = 'base',
  ariaLabel,
  prefixIcon = 'none',
  showArrow = true,
  colorScheme = 'accent',
  class: className,
  'data-testid': testId,
  ...attrs
} = Astro.props;

// Base classes shared by button variants
const buttonBase = 'inline-flex items-center justify-center rounded-lg transition-colors duration-150';

// Button color schemes
const buttonColors: Record<string, string> = {
  accent: 'bg-accent dark:bg-accent text-white hover:bg-accent-hover dark:hover:bg-accent-hover',
  neutral: cn(
    'bg-surface dark:bg-surface-dark',
    'text-text dark:text-text-dark',
    'hover:bg-accent hover:text-white dark:hover:bg-accent-dark'
  ),
};

// Variant-specific classes (including rounding - don't add generic rounded later)
const variantClasses: Record<string, string> = {
  text: cn(
    'inline-flex items-center rounded',
    'text-text dark:text-text-dark',
    'hover:text-accent dark:hover:text-accent-dark',
    'transition-colors duration-150'
  ),
  button: cn(buttonBase, 'font-medium', buttonColors[colorScheme]),
  'button-outlined': cn(
    buttonBase,
    'border border-border dark:border-border-dark',
    'text-text dark:text-text-dark',
    'hover:bg-surface-dark/5 dark:hover:bg-surface/5'
  ),
  'card-action': cn(
    'inline-flex items-center rounded',
    'text-accent dark:text-accent-dark',
    'hover:underline',
    'px-1 -mx-1'
  ),
  badge: cn(
    'inline-flex items-center rounded-full font-medium',
    'bg-bg/90 dark:bg-bg-dark/90 backdrop-blur-sm',
    'text-text dark:text-text-dark',
    'hover:bg-accent hover:text-white dark:hover:bg-accent-dark',
    'transition-colors duration-150'
  ),
};

// Size-specific classes
const sizeClasses: Record<string, string> = {
  xs: 'gap-1 text-xs',
  sm: 'gap-1.5 text-sm',
  base: 'gap-2 px-6 py-3 min-h-11',
  lg: 'gap-2 px-8 py-4 text-lg',
};

// Size adjustments for non-button variants
const textSizeClasses: Record<string, string> = {
  xs: 'gap-1 text-xs',
  sm: 'gap-1.5 text-sm',
  base: 'gap-1.5',
  lg: 'gap-2 text-lg',
};

// Badge size classes
const badgeSizeClasses: Record<string, string> = {
  xs: 'gap-1 px-3 py-2.5 text-xs',
  sm: 'gap-1.5 px-3 py-2 text-sm',
  base: 'gap-2 px-4 py-2.5',
  lg: 'gap-2 px-5 py-3 text-lg',
};

// Determine which size classes to use based on variant
const getSizeClasses = (v: string, s: string): string => {
  if (v === 'button' || v === 'button-outlined') {
    return sizeClasses[s];
  }
  if (v === 'badge') {
    return badgeSizeClasses[s];
  }
  return textSizeClasses[s];
};

// Arrow size based on size variant
const arrowSize = size === 'xs' || size === 'sm' ? 'text-xs' : '';

// Build final class string
const classes = cn(
  variantClasses[variant],
  getSizeClasses(variant, size),
  'focus-ring',
  className
);

// Enhanced aria-label
const fullAriaLabel = `${ariaLabel} (opens in new tab)`;
---

<a
  href={href}
  target="_blank"
  rel="noopener noreferrer"
  class={classes}
  aria-label={fullAriaLabel}
  data-testid={testId}
  {...attrs}
>
  {
    prefixIcon === 'pdf' && (
      <svg
        class="w-4 h-4"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
        />
      </svg>
    )
  }

  {
    prefixIcon === 'github' && (
      <svg
        class="w-4 h-4"
        fill="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          fill-rule="evenodd"
          d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
          clip-rule="evenodd"
        />
      </svg>
    )
  }

  {
    prefixIcon === 'external' && (
      <svg
        class="w-4 h-4"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
        />
      </svg>
    )
  }

  <slot />

  {
    showArrow && (
      <span aria-hidden="true" class={arrowSize}>
        â†—
      </span>
    )
  }
</a>
