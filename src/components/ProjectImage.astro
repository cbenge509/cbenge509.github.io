---
import type {HTMLAttributes} from 'astro/types';
import {Image} from 'astro:assets';
import placeholderImage from '../assets/images/projects/placeholder.svg';
import {cn} from '../utils/cn';

/**
 * ProjectImage component for consistent project image rendering.
 * Handles valid images and placeholder fallback with appropriate sizing per variant.
 *
 * @example
 * ```astro
 * ---
 * import ProjectImage from './ProjectImage.astro';
 * ---
 * <ProjectImage
 *   image={project.image}
 *   alt={`Screenshot of ${project.title}`}
 *   variant="featured"
 * />
 * ```
 */
interface Props extends HTMLAttributes<'div'> {
  image?: ImageMetadata;
  alt: string;
  variant: 'featured' | 'thumbnail';
  hoverScale?: boolean;
}

const {
  image,
  alt,
  variant,
  hoverScale = true,
  class: className,
  ...attrs
} = Astro.props;

const hasValidImage = !!image;

// Base classes for all images
const baseImageClasses = 'w-full h-full object-cover';
const hoverClasses = hoverScale
  ? 'transition-transform duration-300 group-hover:scale-105'
  : '';

// Image configuration based on variant and image availability
type ImageConfig = {
  src: ImageMetadata;
  widths?: number[];
  width?: number;
  height?: number;
  formats?: ('avif' | 'webp')[];
  class: string;
};

// Image configuration lookup table
type ConfigKey = `${'valid' | 'placeholder'}-${'featured' | 'thumbnail'}`;

const IMAGE_CONFIGS: Record<ConfigKey, Omit<ImageConfig, 'src' | 'class'>> = {
  'valid-featured': {
    widths: [400, 800, 1200],
    formats: ['avif', 'webp'],
  },
  'valid-thumbnail': {
    width: 96,
    height: 96,
  },
  'placeholder-featured': {
    width: 800,
    height: 450,
  },
  'placeholder-thumbnail': {
    width: 96,
    height: 96,
  },
};

function getImageConfig(
  hasImage: boolean,
  imageVariant: 'featured' | 'thumbnail',
  imageSource: ImageMetadata
): ImageConfig {
  const configKey: ConfigKey = `${hasImage ? 'valid' : 'placeholder'}-${imageVariant}`;
  const baseConfig = IMAGE_CONFIGS[configKey];

  return {
    ...baseConfig,
    src: hasImage ? imageSource : placeholderImage,
    class: hasImage ? cn(baseImageClasses, hoverClasses) : baseImageClasses,
  };
}

const imageConfig = getImageConfig(hasValidImage, variant, image || placeholderImage);

// Container classes based on variant
const containerClasses =
  variant === 'featured'
    ? 'aspect-video overflow-hidden bg-surface dark:bg-surface-dark'
    : 'flex-shrink-0 w-20 h-20 md:w-24 md:h-24 overflow-hidden bg-surface dark:bg-surface-dark';
---

<div class={cn(containerClasses, className)} {...attrs}>
  <Image
    src={imageConfig.src}
    alt={alt}
    widths={imageConfig.widths}
    width={imageConfig.width}
    height={imageConfig.height}
    formats={imageConfig.formats}
    loading="lazy"
    class={imageConfig.class}
  />
</div>
