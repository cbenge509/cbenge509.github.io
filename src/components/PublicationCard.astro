---
import type {HTMLAttributes} from 'astro/types';
import {cardSurfaceContainerClasses} from '../utils/card-styles';

/**
 * PublicationCard displays a single academic publication with expandable abstract.
 * Follows progressive enhancement: abstracts visible by default, JS adds toggle.
 *
 * Uses utilities:
 * - cardSurfaceContainerClasses() for consistent surface-based card styling
 *
 * @example
 * ```astro
 * <PublicationCard
 *   title="BERTVision: A Parameter-Efficient Approach"
 *   authors={["Cris Benge", "Siduo Jiang"]}
 *   venue="arXiv"
 *   year={2022}
 *   abstract="We present a parameter-efficient approach..."
 *   pdfUrl="https://arxiv.org/pdf/2202.12210"
 *   codeUrl="https://github.com/cbenge509/BERTVision"
 * />
 * ```
 */
export interface Props extends HTMLAttributes<'article'> {
  /** Publication title */
  title: string;
  /** List of authors */
  authors: string[];
  /** Conference, journal, or venue name */
  venue: string;
  /** Publication year */
  year: number;
  /** Abstract text (optional - toggle hidden if not provided) */
  abstract?: string;
  /** URL to PDF document */
  pdfUrl?: string;
  /** URL to code repository */
  codeUrl?: string;
  /** DOI URL */
  doiUrl?: string;
}

const {
  title,
  authors,
  venue,
  year,
  abstract,
  pdfUrl,
  codeUrl,
  doiUrl,
  class: className,
  ...attrs
} = Astro.props;

// Highlight Cris in authors list
const highlightedAuthors = authors.map((author) => ({
  name: author,
  highlight:
    author.toLowerCase().includes('cris') ||
    author.toLowerCase().includes('benge'),
}));

const hasAbstract = abstract && abstract.trim().length > 0;
const hasLinks = pdfUrl || codeUrl || doiUrl;
---

<article
  data-component="publication-card"
  class={cardSurfaceContainerClasses(`publication-card ${className || ''}`)}
  {...attrs}
>
  <!-- Header: Year and Venue -->
  <div
    class="flex items-center gap-2 text-sm text-text-secondary dark:text-text-secondary-dark mb-2"
  >
    <span class="font-medium">{year}</span>
    <span aria-hidden="true">·</span>
    <span>{venue}</span>
  </div>

  <!-- Title -->
  <h3
    class="font-display text-lg md:text-xl font-semibold text-text dark:text-text-dark"
  >
    {title}
  </h3>

  <!-- Authors -->
  <p class="mt-2 text-sm text-text-secondary dark:text-text-secondary-dark">
    {
      highlightedAuthors.map((author, index) => (
        <>
          {author.highlight ? (
            <span class="author-highlight font-semibold text-text dark:text-text-dark">
              {author.name}
            </span>
          ) : (
            <span>{author.name}</span>
          )}
          {index < highlightedAuthors.length - 1 && ', '}
        </>
      ))
    }
  </p>

  <!-- Links Row -->
  {
    hasLinks && (
      <div class="mt-4 flex flex-wrap items-center gap-3">
        {pdfUrl && (
          <a
            href={pdfUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-1.5 text-sm text-accent dark:text-accent-dark hover:underline focus-ring rounded px-1 -mx-1"
            aria-label={`Download PDF of ${title} (opens in new tab)`}
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
              />
            </svg>
            PDF
            <span aria-hidden="true" class="text-xs">
              ↗
            </span>
          </a>
        )}

        {codeUrl && (
          <a
            href={codeUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-1.5 text-sm text-accent dark:text-accent-dark hover:underline focus-ring rounded px-1 -mx-1"
            aria-label={`View code for ${title} on GitHub (opens in new tab)`}
          >
            <svg
              class="w-4 h-4"
              fill="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                fill-rule="evenodd"
                d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
                clip-rule="evenodd"
              />
            </svg>
            Code
            <span aria-hidden="true" class="text-xs">
              ↗
            </span>
          </a>
        )}

        {doiUrl && (
          <a
            href={doiUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-1.5 text-sm text-accent dark:text-accent-dark hover:underline focus-ring rounded px-1 -mx-1"
            aria-label={`View DOI for ${title} (opens in new tab)`}
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
              />
            </svg>
            DOI
            <span aria-hidden="true" class="text-xs">
              ↗
            </span>
          </a>
        )}
      </div>
    )
  }

  <!-- Abstract Section (Progressive Enhancement) -->
  {
    hasAbstract && (
      <div data-abstract-section class="mt-4">
        <button
          type="button"
          data-toggle
          aria-expanded="true"
          aria-controls={`abstract-${title.replace(/\s+/g, '-').toLowerCase()}`}
          class="abstract-toggle inline-flex items-center gap-1 text-sm text-accent dark:text-accent-dark hover:underline focus-ring rounded px-2 -mx-2 min-h-11"
        >
          <svg
            class="toggle-icon w-4 h-4 transition-transform duration-150"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            />
          </svg>
          <span data-toggle-text>Hide Abstract</span>
        </button>

        <div
          id={`abstract-${title.replace(/\s+/g, '-').toLowerCase()}`}
          data-abstract
          class="abstract-container expanded mt-3 text-sm text-text-secondary dark:text-text-secondary-dark leading-relaxed"
        >
          {abstract}
        </div>
      </div>
    )
  }
</article>

<style>
  /* Abstract container animation */
  .abstract-container {
    overflow: hidden;
    transition:
      max-height 300ms ease-out,
      opacity 300ms ease-out;
    max-height: 500px;
    opacity: 1;
  }

  .abstract-container:not(.expanded) {
    max-height: 0;
    opacity: 0;
  }

  /* Toggle icon rotation */
  .abstract-toggle[aria-expanded='true'] .toggle-icon {
    transform: rotate(0deg);
  }

  .abstract-toggle[aria-expanded='false'] .toggle-icon {
    transform: rotate(-90deg);
  }

  /* Reduced motion - opacity only */
  @media (prefers-reduced-motion: reduce) {
    .abstract-container {
      transition: opacity 150ms ease-out;
      max-height: none !important;
    }

    .abstract-container:not(.expanded) {
      height: 0;
      overflow: hidden;
    }

    .toggle-icon {
      transition: none;
    }
  }
</style>

<script>
  // Progressive enhancement for abstract toggle
  // Abstracts are visible by default (expanded), JS collapses them initially
  document.addEventListener('DOMContentLoaded', () => {
    document
      .querySelectorAll('[data-component="publication-card"]')
      .forEach((card) => {
        const toggle = card.querySelector('[data-toggle]') as HTMLButtonElement;
        const abstract = card.querySelector('[data-abstract]') as HTMLElement;
        const toggleText = card.querySelector(
          '[data-toggle-text]'
        ) as HTMLElement;

        if (!toggle || !abstract || !toggleText) return;

        // Initially collapse abstracts (JS enhancement)
        abstract.classList.remove('expanded');
        toggle.setAttribute('aria-expanded', 'false');
        toggleText.textContent = 'Show Abstract';

        toggle.addEventListener('click', () => {
          const isExpanded = toggle.getAttribute('aria-expanded') === 'true';

          toggle.setAttribute('aria-expanded', String(!isExpanded));
          abstract.classList.toggle('expanded');
          toggleText.textContent = isExpanded ? 'Show Abstract' : 'Hide Abstract';
        });
      });
  });
</script>
