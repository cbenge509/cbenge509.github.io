---
import type {HTMLAttributes} from 'astro/types';
import {cardSurfaceContainerClasses, BULLET_SEPARATOR} from '../utils/card-styles';
import {toSlugId} from '../utils/id-utils';
import {cn} from '../utils/cn';
import ExternalLink from './ExternalLink.astro';

/**
 * PublicationCard displays a single academic publication with expandable abstract.
 * Follows progressive enhancement: abstracts visible by default, JS adds toggle.
 *
 * Uses utilities:
 * - cardSurfaceContainerClasses() for consistent surface-based card styling
 * - toSlugId() for generating accessible abstract element IDs
 *
 * @example
 * ```astro
 * <PublicationCard
 *   title="BERTVision: A Parameter-Efficient Approach"
 *   authors={["Cris Benge", "Siduo Jiang"]}
 *   venue="arXiv"
 *   year={2022}
 *   abstract="We present a parameter-efficient approach..."
 *   pdfUrl="https://arxiv.org/pdf/2202.12210"
 *   codeUrl="https://github.com/cbenge509/BERTVision"
 * />
 * ```
 */
export interface Props extends HTMLAttributes<'article'> {
  title: string;
  authors: string[];
  venue: string;
  year: number;
  /** Toggle hidden if not provided */
  abstract?: string;
  pdfUrl?: string;
  codeUrl?: string;
  doiUrl?: string;
}

const {
  title,
  authors,
  venue,
  year,
  abstract,
  pdfUrl,
  codeUrl,
  doiUrl,
  class: className,
  ...attrs
} = Astro.props;

// Highlight Cris in authors list
const highlightedAuthors = authors.map((author) => ({
  name: author,
  highlight:
    author.toLowerCase().includes('cris') ||
    author.toLowerCase().includes('benge'),
}));

const hasAbstract = abstract && abstract.trim().length > 0;
const hasLinks = pdfUrl || codeUrl || doiUrl;
---

<article
  data-component="publication-card"
  class={cardSurfaceContainerClasses(cn('publication-card', className))}
  {...attrs}
>
  <!-- Header: Year and Venue -->
  <div
    class="flex items-center gap-2 text-sm text-text-secondary dark:text-text-secondary-dark mb-2"
  >
    <span class="font-medium">{year}</span>
    <Fragment set:html={BULLET_SEPARATOR} />
    <span>{venue}</span>
  </div>

  <!-- Title -->
  <h3
    class="font-display text-lg md:text-xl font-semibold text-text dark:text-text-dark"
  >
    {title}
  </h3>

  <!-- Authors -->
  <p class="mt-2 text-sm text-text-secondary dark:text-text-secondary-dark">
    {
      highlightedAuthors.map((author, index) => (
        <>
          {author.highlight ? (
            <span class="author-highlight font-semibold text-text dark:text-text-dark">
              {author.name}
            </span>
          ) : (
            <span>{author.name}</span>
          )}
          {index < highlightedAuthors.length - 1 && ', '}
        </>
      ))
    }
  </p>

  <!-- Links Row -->
  {
    hasLinks && (
      <div class="mt-4 flex flex-wrap items-center gap-3">
        {pdfUrl && (
          <ExternalLink
            href={pdfUrl}
            variant="card-action"
            size="sm"
            prefixIcon="pdf"
            ariaLabel={`Download PDF of ${title}`}
          >
            PDF
          </ExternalLink>
        )}

        {codeUrl && (
          <ExternalLink
            href={codeUrl}
            variant="card-action"
            size="sm"
            prefixIcon="github"
            ariaLabel={`View code for ${title} on GitHub`}
          >
            Code
          </ExternalLink>
        )}

        {doiUrl && (
          <ExternalLink
            href={doiUrl}
            variant="card-action"
            size="sm"
            prefixIcon="external"
            ariaLabel={`View DOI for ${title}`}
          >
            DOI
          </ExternalLink>
        )}
      </div>
    )
  }

  <!-- Abstract Section (Progressive Enhancement) -->
  {
    hasAbstract && (
      <div data-abstract-section class="mt-4">
        <button
          type="button"
          data-toggle
          aria-expanded="true"
          aria-controls={toSlugId(title, 'abstract')}
          class="abstract-toggle inline-flex items-center gap-1 text-sm text-accent dark:text-accent-dark hover:underline focus-ring rounded px-2 -mx-2 min-h-11"
        >
          <svg
            class="toggle-icon w-4 h-4 transition-transform duration-150"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            />
          </svg>
          <span data-toggle-text>Hide Abstract</span>
        </button>

        <div
          id={toSlugId(title, 'abstract')}
          data-abstract
          class="abstract-container expanded mt-3 text-sm text-text-secondary dark:text-text-secondary-dark leading-relaxed"
        >
          {abstract}
        </div>
      </div>
    )
  }
</article>

<style>
  /* Abstract container animation */
  .abstract-container {
    overflow: hidden;
    transition:
      max-height 300ms ease-out,
      opacity 300ms ease-out;
    max-height: 500px;
    opacity: 1;
  }

  .abstract-container:not(.expanded) {
    max-height: 0;
    opacity: 0;
  }

  /* Toggle icon rotation */
  .abstract-toggle[aria-expanded='true'] .toggle-icon {
    transform: rotate(0deg);
  }

  .abstract-toggle[aria-expanded='false'] .toggle-icon {
    transform: rotate(-90deg);
  }

  /* Reduced motion - opacity only */
  @media (prefers-reduced-motion: reduce) {
    .abstract-container {
      transition: opacity 150ms ease-out;
      max-height: none !important;
    }

    .abstract-container:not(.expanded) {
      height: 0;
      overflow: hidden;
    }

    .toggle-icon {
      transition: none;
    }
  }
</style>

<script>
  import '../scripts/publication-card';
</script>
