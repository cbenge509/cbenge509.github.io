---
import type {HTMLAttributes} from 'astro/types';
import {Image} from 'astro:assets';
import ProjectTag from './ProjectTag.astro';
import ExternalLink from './ExternalLink.astro';
import placeholderImage from '../assets/images/projects/placeholder.svg';
import {CATEGORY_TO_VARIANT, CATEGORY_LABELS, type ProjectData} from '../utils/project-categories';

/**
 * Featured Project Card component for displaying highlighted projects
 * Displays full 16:9 image, title, description, tags, and optional GitHub link
 *
 * Uses utilities:
 * - CATEGORY_TO_VARIANT for mapping categories to tag variants
 * - CATEGORY_LABELS for display labels
 * - Global line-clamp utilities for text truncation
 *
 * @example
 * ```astro
 * ---
 * const project = await getEntry('projects', 'ml-pipeline');
 * ---
 * <FeaturedProjectCard
 *   project={project.data}
 *   slug={project.slug}
 * />
 * ```
 */
export interface Props extends HTMLAttributes<'article'> {
  /** Project data from content collection */
  project: ProjectData;
  /** Project slug for linking to detail page */
  slug: string;
}

const {project, slug, class: className, ...attrs} = Astro.props;

// Use project image directly (now ImageMetadata from content collection)
const imageSource = project.image || placeholderImage;
const hasValidImage = !!project.image;
---

<article
  data-component="featured-project-card"
  class:list={[
    'group relative block rounded-lg overflow-hidden',
    'bg-surface dark:bg-surface-dark',
    'shadow-sm hover:shadow-lg',
    'transition-all duration-150 ease-out',
    'hover:-translate-y-1',
    'active:scale-[0.98]',
    'focus-within:ring-2 focus-within:ring-accent dark:focus-within:ring-accent-dark',
    'focus-within:ring-offset-2 focus-within:ring-offset-bg dark:focus-within:ring-offset-bg-dark',
    className,
  ]}
  {...attrs}
>
  <a
    href={`/projects/${slug}`}
    class="block focus:outline-none"
    aria-labelledby={`project-title-${slug}`}
  >
    <!-- Image container with 16:9 aspect ratio -->
    <div class="aspect-video overflow-hidden bg-surface dark:bg-surface-dark">
      {
        hasValidImage ? (
          <Image
            src={imageSource}
            alt={`Screenshot of ${project.title} project`}
            widths={[400, 800, 1200]}
            formats={['avif', 'webp']}
            loading="lazy"
            class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
          />
        ) : (
          <Image
            src={placeholderImage}
            alt={project.title}
            width={800}
            height={450}
            loading="lazy"
            class="w-full h-full object-cover"
          />
        )
      }
    </div>

    <!-- Content -->
    <div class="p-4 md:p-6">
      <!-- Title -->
      <h3
        id={`project-title-${slug}`}
        class="font-display text-lg md:text-xl font-semibold text-text dark:text-text-dark line-clamp-1"
      >
        {project.title}
      </h3>

      <!-- Description - 2-3 lines with truncation -->
      <p
        class="mt-2 text-body text-text-secondary dark:text-text-secondary-dark line-clamp-3"
      >
        {project.description}
      </p>

      <!-- Tags and GitHub link row -->
      <div class="mt-4 flex flex-wrap items-center gap-2">
        <!-- Primary category tag -->
        <ProjectTag variant={CATEGORY_TO_VARIANT[project.category]}>
          {CATEGORY_LABELS[project.category]}
        </ProjectTag>

        <!-- Achievement tag if winner -->
        {
          project.achievement && project.category === 'winner' && (
            <span class="text-xs text-text-secondary dark:text-text-secondary-dark">
              {project.achievement}
            </span>
          )
        }
      </div>
    </div>
  </a>

  <!-- GitHub link (outside main link for separate interaction) -->
  {
    project.githubUrl && (
      <div class="absolute top-4 right-4">
        <ExternalLink
          href={project.githubUrl}
          variant="badge"
          size="xs"
          ariaLabel={`View ${project.title} on GitHub`}
          class="min-h-11"
          data-github-link
        >
          GitHub
        </ExternalLink>
      </div>
    )
  }
</article>

<script>
  // Stop propagation on GitHub links to prevent card navigation
  // Uses event delegation per project security standards (no inline handlers)
  document.addEventListener('click', (event) => {
    const target = event.target as HTMLElement;
    const githubLink = target.closest('[data-github-link]');
    if (githubLink) {
      event.stopPropagation();
    }
  });
</script>
